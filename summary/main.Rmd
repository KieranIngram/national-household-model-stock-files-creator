# Summary report for `r stock.name` #

This is a report generated as part of the stock import process.
It provides some final summary statistics on the report, which are generated by running the stock importer and the NHM over the stock.

```{r eval=TRUE, echo=FALSE}
if (file.exists("summary.stock")) unlink("summary.stock")
system(paste("java -jar nhm.jar import dto",
             file.path(stock.path, paste(stock.name, ".zip", sep="")),
             "summary.stock"))
if (file.exists("summary.zip")) unlink("summary.zip")
system(paste("java -jar nhm.jar run ./summary.scenario summary.zip"))
```

```{r eval=TRUE, echo=FALSE}
all.data <- data.table(
    read.table(unz("summary.zip", "dwelling/probe-output.tab"),
               header=T, sep="\t"))
```

# Basic statistics #

There are $`r sum(all.data$weight)`$ dwellings in this stock, and $`r length(unique(all.data$aacode))`$ distinct cases. Let's look at some cross-tabs

```{r eval=TRUE, echo=FALSE}
# these are just some functions for below
add.margins <- function(f, row=TRUE, col=TRUE) {
    if (col) f <- rbind(f, colSums(f))
    if (row) cbind(f, rowSums(f))
    else f
}

print.table <- function(t) knitr::kable(t)
```

## Region, form, tenure ##

```{r eval=TRUE, echo=FALSE, results='asis'}
print.table(
    as.data.frame(xtabs(weight ~ region, all.data))
)
```

```{r eval=TRUE, echo=FALSE, results='asis'}
print.table(
    add.margins(xtabs(weight ~ form + tenure, all.data)))
```
\newpage

## Heating systems ##

```{r eval=TRUE, echo=FALSE, results='asis'}
print.table((as.data.frame(xtabs(weight ~ fuel, all.data))))
```

```{r eval=TRUE,echo=FALSE,  results='asis'}
print.table((as.data.frame(xtabs(weight ~ system, all.data))))
```

\newpage

# SAP Scores #

```{r eval=TRUE, echo=FALSE, results='asis'}
sap.bands  <- data.frame(
    score=c(0, 20, 38, 54, 68, 80, 91),
    band=c("G", "F", "E", "D", "C", "B", "A")
)

to.sap.band <- function(score)
    cut(score, c(sap.bands$score,  1000),
        labels=sap.bands$band)

all.data$sap.band     <- to.sap.band(all.data$sap09)
all.data$nhm.sap.band <- to.sap.band(all.data$nhm.sap09)

print.table(add.margins(
    xtabs(weight ~ sap.band + nhm.sap.band, all.data)))
```

## Survey and modelled SAP scores ##

```{r eval=TRUE, echo=FALSE}
all.data$sap09 <- as.double(all.data$sap09)
all.data$ins <- as.character(all.data$ins)
all.data$ins[all.data$ins == "true"] <- "Has some insulation"
all.data$ins[all.data$ins == "false"] <- "Has no insulation"

transformed.data <- melt(all.data, measure.vars=c("nhm.sap09", "sap09"))

middles <- function(row) (row + c(row[2:length(row)], 100))/2
subs <- function(row) Reduce(c,
                             mapply(
                                 function(f, t) (f + ((t - f) * (1:4) / 4)),
                                 row, c(row[2:length(row)], 100)))
```

```{r eval=TRUE, messages=FALSE, errors=FALSE, warnings=FALSE, results='hold', collapse=TRUE, echo=FALSE, fig.width=8, fig.height=10}
base.histograms <-
ggplot(transformed.data) +
    geom_histogram(aes(x=value, linetype=variable, color=variable, weight=weight),
                   breaks=sap.bands$score,
                   alpha=0.05, position="identity") +
    geom_histogram(aes(x=value, linetype=variable, color=variable, fill=variable, weight=weight),
                   breaks=subs(sap.bands$score),
                   size=0.1,
                   alpha=0.3,
                   position="identity")
base.histograms +
    geom_text(aes(middles(score), 0, label=band, color=NULL, weight=NULL),
              sap.bands,
              size=2.5,
              vjust=1.4,
              alpha=0.5)
```

```{r eval=TRUE, messages=FALSE, errors=FALSE, warnings=FALSE, results='hold', collapse=TRUE, echo=FALSE, fig.width=8, fig.height=10}
base.histograms + facet_wrap("system", ncol=1, scale="free_y")
```


```{r eval=TRUE, messages=FALSE, errors=FALSE, warnings=FALSE, results='hold', collapse=TRUE, echo=FALSE, fig.width=8, fig.height=10}
base.histograms + facet_wrap("form", ncol=1, scale="free_y")
```

```{r eval=TRUE, messages=FALSE, errors=FALSE, warnings=FALSE, results='hold', collapse=TRUE, echo=FALSE, fig.width=8, fig.height=10}
base.histograms + facet_wrap("fuel", ncol=1, scale="free_y")
```

```{r eval=TRUE, messages=FALSE, errors=FALSE, warnings=FALSE, results='hold', collapse=TRUE, echo=FALSE, fig.width=8, fig.height=10}
base.histograms + facet_wrap("tenure", ncol=1, scale="free_y")
```

```{r eval=TRUE, messages=FALSE, errors=FALSE, warnings=FALSE, results='hold', collapse=TRUE, echo=FALSE, fig.width=8, fig.height=10}
base.histograms + facet_grid(wall~ins, scale="free_y")
```

```{r eval=TRUE, messages=FALSE, errors=FALSE, warnings=FALSE, results='hold', collapse=TRUE, echo=FALSE, fig.width=8, fig.height=10}
base.histograms + facet_wrap("sap.age.band", ncol=1, scale="free_y")
```

## SAP Scatter Plot ##

```{r eval=TRUE, echo=FALSE}
## this code hacks geom hex to support weighted counts. Merge request not yet done.
stat_binhex <- function (mapping = NULL, data = NULL, geom = "hex", position = "identity",
bins = 30, na.rm = FALSE, ...) {
  StatBinhex$new(mapping = mapping, data = data, geom = geom, position = position,
  bins = bins, na.rm = na.rm, ...)
}

StatBinhex <- proto::proto(ggplot2:::Stat, {
  objname <- "binhex"

  default_aes <- function(.) aes(fill = ..count..)
  required_aes <- c("x", "y")
  default_geom <- function(.) GeomHex


  calculate <- function(., data, scales, binwidth = NULL, bins = 30, na.rm = FALSE, ...) {
    try_require("hexbin")
    data <- remove_missing(data, na.rm, c("x", "y", "weight"), name="stat_hexbin")

    if (is.null(binwidth)) {
      binwidth <- c(
        diff(scale_dimension(scales$x, c(0, 0))) / bins,
        diff(scale_dimension(scales$y, c(0, 0))) / bins
      )
    }

    hexBin(data$x, data$y, data$weight, binwidth)
  }
})

# Bin 2d plane into hexagons
# Wrapper around \code{\link[hexbin]{hcell2xy}} that returns a data frame
#
# @param x positions
# @param y positions
# @param weight weights for points, or null if equally weighted
# @param numeric vector of length 2 giving binwidth in x and y directions
# @keyword internal
hexBin <- function(x, y, weight, binwidth) {
  try_require("hexbin")

  # Convert binwidths into bounds + nbins
  xbnds <- c(
    round_any(min(x), binwidth[1], floor) - 1e-6,
    round_any(max(x), binwidth[1], ceiling) + 1e-6
  )
  xbins <- diff(xbnds) / binwidth[1]

  ybnds <- c(
    round_any(min(y), binwidth[2], floor) - 1e-6,
    round_any(max(y), binwidth[2], ceiling) + 1e-6
  )
  ybins <- diff(ybnds) / binwidth[2]

  # Call hexbin
  hb <- hexbin(
    x, xbnds = xbnds, xbins = xbins,
    y, ybnds = ybnds, shape = ybins / xbins,
    IDs = !is.null(weight),
  )

  if (!is.null(weight)) {
      ## we need to produce weights for each cell rather than counts. hb@cID contains the
      ## ID of the cell for each input point and hb@cell contains the vector of cell IDs
      ## which relate to values in hb@count.

      ## first we want to sum the weight in each cID
      sumWeights <- tapply(weight, hb@cID, sum)

      ## finally we want to join the weights back onto the "compressed" list of cells, because
      ## some cells do not get produced (they have nothing in them)
      ## hb@cell contains the indices that have actually been used, in the order they occur
      count <- sumWeights[match(hb@cell, names(sumWeights))]
  } else {
      count <- hb@count
  }

  # Convert to data frame
  data.frame(
    hcell2xy(hb),
    count = count,
    density = count / sum(count, na.rm=TRUE)
  )
}
```

```{r eval=TRUE, echo=FALSE, fig.width=9, fig.height=10, fig.align='center'}
qplot(sap09, nhm.sap09, data=all.data, geom="hex", weight=weight) +
    scale_fill_gradientn(colours=c("white","blue")) +
    geom_abline(slope=1, alpha=0.5) +
    geom_rug(col=rgb(0,0,1,alpha=.01)) +
    stat_smooth(formula=y~x, method="lm", aes(weight=weight), color="red", alpha=0.5) +
    coord_fixed()
```

```{r eval=TRUE, echo=FALSE, fig.width=9, fig.height=10, fig.align='center'}
qplot(sap09, nhm.sap09, data=all.data, geom="hex", weight=weight) +
    scale_fill_gradientn(colours=c("white","blue")) +
    geom_abline(slope=1, alpha=0.5) +
    geom_rug(col=rgb(0,0,1,alpha=.01)) +
    stat_smooth(formula=y~x, method="lm", aes(weight=weight), color="red", alpha=0.5) +
    facet_wrap("system", ncol=5) +
    coord_fixed()
```

```{r eval=TRUE, echo=FALSE, fig.width=9, fig.height=10, fig.align='center'}
qplot(sap09, nhm.sap09, data=all.data, geom="hex", weight=weight) +
    scale_fill_gradientn(colours=c("white","blue")) +
    geom_abline(slope=1, alpha=0.5) +
    geom_rug(col=rgb(0,0,1,alpha=.01)) +
    stat_smooth(formula=y~x, method="lm", aes(weight=weight), color="red", alpha=0.5) +
    facet_grid(ins~wall) +
    coord_fixed()
```

```{r eval=TRUE, echo=FALSE, fig.width=9, fig.height=10, fig.align='center'}
qplot(sap09, nhm.sap09, data=all.data, geom="hex", weight=weight) +
    scale_fill_gradientn(colours=c("white","blue")) +
    geom_abline(slope=1, alpha=0.5) +
    geom_rug(col=rgb(0,0,1,alpha=.01)) +
    stat_smooth(formula=y~x, method="lm", aes(weight=weight), color="red", alpha=0.5) +
    facet_wrap("sap.age.band", ncol=4) +
    coord_fixed()
```
